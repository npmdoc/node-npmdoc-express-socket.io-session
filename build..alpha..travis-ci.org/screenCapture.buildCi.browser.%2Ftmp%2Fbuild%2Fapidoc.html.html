<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/oskosk/express-socket.io-session#readme">express-socket.io-session (v1.3.2)</a>
</h1>
<h4>Share a cookie-based express-session middleware with socket.io</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-socket.io-session">module express-socket.io-session</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-socket.io-session.io-session">
            function <span class="apidocSignatureSpan">express-socket.</span>io-session
            <span class="apidocSignatureSpan">(expressSessionMiddleware, cookieParserMiddleware, options)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-socket.io-session" id="apidoc.module.express-socket.io-session">module express-socket.io-session</a></h1>


    <h2>
        <a href="#apidoc.element.express-socket.io-session.io-session" id="apidoc.element.express-socket.io-session.io-session">
        function <span class="apidocSignatureSpan">express-socket.</span>io-session
        <span class="apidocSignatureSpan">(expressSessionMiddleware, cookieParserMiddleware, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">io-session = function (expressSessionMiddleware, cookieParserMiddleware, options) {
  var socketIoSharedSessionMiddleware;

  // Accept options as second argument if only 2 parameters passed
  if (arguments.length == 2 &amp;&amp; typeof cookieParserMiddleware === 'object') {
    options = cookieParserMiddleware;
    cookieParserMiddleware = undefined;
  }

  if (typeof cookieParserMiddleware === 'undefined') {
    debug("No cookie-parser instance passed as argument. Creating a cookie-parser " +
      "instance with default values");
    cookieParserMiddleware = cookieparser();
  }
  options = options || {};
  var saveUninitializedSession = options.saveUninitialized;
  debug("Creating socket.io middleware");

  socketIoSharedSessionMiddleware = function(socket, next) {
    var req = socket.handshake;
    var res = {
      end: function() {}
    };
    // originalHash, savedHash, originalId, cookieId
    // are variables present for replicating express-session autoSaving behavioiur
    var originalHash, savedHash;
    var originalId;
    var cookieId;
    var _onevent = socket.onevent;
    // Override socket.on if autoSave = true;
    if (options.autoSave === true) {
      debug("Using autoSave feature. express-session middleware will be called on every event received")
      socket.onevent = function() {
        debug("Executing socket.onevent monkeypatched by express-socket.io-session");
        var _args = arguments;
        originalHash = savedHash = hash(req.session);
        cookieId = req.sessionID;
        originalId = req.sessionID;
        _onevent.apply(socket, _args);
        if (shouldSave(req)) {
          req.session.save()
        }
      };
    }
    //Parse session cookie
    cookieParserMiddleware(req, res, function(err) {
      if (err) {
        debug("cookieParser errored");
        return next(err);
      }
      expressSessionMiddleware(req, res, function(req, res) {
        next();
      });
    });
<span class="apidocCodeCommentSpan">    /*
     * These functions hash, isModified, isSaved, shouldSave
     * and shouldDestroy are canibalized from express-session
     * in order to this module being able to comply with the autoSave options.
     */
</span>
    /**
     * Hash the given `sess` object omitting changes to `.cookie`.
     *
     * @param {Object} sess
     * @return {String}
     * @private
     */

    function hash(sess) {
      return crc(JSON.stringify(sess, function(key, val) {
        if (key !== 'cookie') {
          return val;
        }
      }));
    }

    // check if session has been modified
    function isModified(sess) {
      return originalId !== sess.id || originalHash !== hash(sess);
    }

    // check if session has been saved
    function isSaved(sess) {
      return originalId === sess.id &amp;&amp; savedHash === hash(sess);
    }

    // determine if session should be destroyed
    function shouldDestroy(req) {
      return req.sessionID &amp;&amp; unsetDestroy &amp;&amp; req.session == null;
    }

    // determine if session should be saved to store
    function shouldSave(req) {
      // cannot set cookie without a session ID
      if (typeof req.sessionID !== 'string') {
        debug('session ignored because of bogus req.sessionID %o', req.sessionID);
        return false;
      }

      return !saveUninitializedSession &amp;&amp; cookieId !== req.sessionID ? isModified(req.session) : !isSaved(req.session)
    }
  };


  return socketIoSharedSessionMiddleware;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>